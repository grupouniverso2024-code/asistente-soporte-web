<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Componente Botón de Soporte Fijo y Simple</title>
    <!-- Incluye Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons para los íconos -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fuente Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* Definición de la paleta de colores */
        :root {
            --color-primary: #243a85; /* Azul corporativo oscuro */
            --color-neon: #4f68b3; /* Azul para el efecto de brillo */
            --color-dark-bg: #1f2937; /* Gris oscuro para el fondo del chat */
            --color-modal-bg: #111827; /* Negro/Azul muy oscuro para el modal */
        }

        /* Estilos generales */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: transparent; 
            min-height: 100vh; 
            margin: 0; 
            position: relative; 
            width: 100%;
            overflow: hidden; 
        }
        
        /* Contenedor del Botón y Modal: Fijo y Simple */
        .support-container-fixed {
            /* Posición absoluta pegada a la esquina del Iframe */
            position: absolute; 
            bottom: 0; 
            right: 0; 
            z-index: 100; 
            display: flex;
            flex-direction: column;
            align-items: flex-end; 
            padding: 1.5rem; 
        }

        /* Modal de Soporte IA */
        #ai-support-modal {
            margin-bottom: 0.5rem;
            width: 320px; 
            max-height: 450px;
            z-index: 99;
            background-color: var(--color-modal-bg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); 
            border: 1px solid var(--color-neon);
            transition: all 0.2s ease-out; 
            transform-origin: bottom right;
        }
        
        .header-glow {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid white;
            background-color: var(--color-primary); 
            color: white; 
        }

        .modal-closed {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        .modal-open {
            opacity: 1;
            transform: scale(1);
        }
        
        .chat-history {
            max-height: 300px; 
            overflow-y: auto;
            background-color: var(--color-dark-bg);
        }
        
        /* Estilos de burbujas */
        .bubble-user {
            background-color: var(--color-primary); 
            color: white; 
            border-radius: 12px 12px 0 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .bubble-model {
            background-color: white; 
            color: var(--color-primary); 
            border: 1px solid rgba(36, 58, 133, 0.2); 
            border-radius: 12px 12px 12px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
        }

        /* Botón de Interacción: Estilo de botón fijo y robusto */
        .fixed-support-button {
            background-color: var(--color-primary); 
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); 
            transition: all 0.15s ease-in-out;
            border: 2px solid white; 
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fixed-support-button:hover {
            background-color: #1c2b6a; 
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
        }
        
        /* Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--color-primary); 
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Logo "U" con Anillo Gravitacional */
        @keyframes ring-spin {
            to {
                transform: rotate(360deg);
            }
        }
        .gravitational-ring {
            animation: ring-spin 12s linear infinite; 
            transform-origin: 50% 50%; 
            stroke: var(--color-neon); 
            stroke-width: 1.5;
            fill: none;
            stroke-dasharray: 8 8; 
            transition: stroke 0.3s;
        }
    </style>
</head>
<body>

    <!-- CONTENEDOR FIJO QUE ALBERGA EL MODAL Y EL BOTÓN -->
    <div class="support-container-fixed">

        <!-- MODAL DE SOPORTE IA -->
        <div id="ai-support-modal" 
            class="modal-closed rounded-xl">
            
            <!-- Encabezado del chat -->
            <div class="header-glow p-3 rounded-t-xl flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <!-- Logo "U" con Anillo Gravitacional -->
                    <div class="w-8 h-8 flex items-center justify-center relative">
                        <svg viewBox="0 0 40 40" class="w-full h-full absolute">
                            <circle class="gravitational-ring" cx="20" cy="20" r="18"></circle>
                        </svg>
                        <!-- Letra "U" en el centro -->
                        <span class="text-white text-lg font-extrabold z-10 select-none" style="font-family: 'Montserrat', sans-serif; line-height: 1;">U</span>
                    </div>

                    <h3 class="text-white text-base font-bold">Universo Helper</h3>
                </div>
                
                <!-- Botón de cierre -->
                <button id="close-modal-btn" class="text-white hover:text-gray-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Historial del chat -->
            <div id="chat-history" class="chat-history p-4 space-y-4">
                <!-- Mensaje de bienvenida de la IA -->
            </div>

            <!-- Formulario de entrada -->
            <div class="p-3 border-t border-gray-700 bg-gray-900 rounded-b-xl">
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="user-input" placeholder="Escribe tu pregunta..." 
                        class="flex-grow p-2 text-sm text-white bg-gray-800 border border-gray-700 rounded-lg focus:ring-[var(--color-neon)] focus:border-[var(--color-neon)]" required>
                    <!-- Botón de Enviar -->
                    <button type="submit" id="send-btn" 
                            class="bg-[var(--color-primary)] text-white p-2 rounded-lg hover:bg-[#324a90] transition-colors flex items-center justify-center shadow-md hover:shadow-lg">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </form>
                <!-- ENLACE DE ESCALADA -->
                <a id="escalate-link" href="http://192.168.0.101/soporte/" class="block text-center text-xs text-[var(--color-neon)] mt-2 hover:underline font-medium" target="_blank">
                    <i data-lucide="message-square" class="w-3 h-3 inline-block mr-1"></i> Abrir un Ticket con Soporte
                </a>
            </div>
        </div>


        <!-- BOTÓN DE SOPORTE FIJO Y SIMPLE -->
        <button id="support-toggle-button" 
            class="fixed-support-button" 
            title="Abrir Asistente Universo Helper">
            
            <i data-lucide="message-square" class="w-5 h-5"></i>
            Asistente de Soporte
        </button>
    </div>


    <script>
        // Clave API (se inyectará en runtime por Canvas si está vacía)
        const apiKey = ""; 

        // ----------------------------------------------------
        // I. UTILIDADES
        // ----------------------------------------------------

        /**
         * Realiza una llamada al API de Gemini con manejo de reintentos (Exponential Backoff).
         */
        async function fetchWithRetry(payload, maxRetries = 3, delay = 1000) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue;
                    }

                    if (!response.ok) {
                        // REGISTRO DE ERRORES: Muestra el error de red o de la API en la consola
                        const errorBody = await response.text();
                        console.error(`Gemini API Failed (${response.status} - Intento ${i + 1}):`, errorBody);
                        throw new Error(`API call failed with status ${response.status}`);
                    }

                    return response.json();

                } catch (error) {
                    if (error.message.includes('Failed to fetch')) {
                        // ESTE ES EL ERROR TÍPICO DE CSP/CORS EN IFRAMES (Google Sites)
                        console.error("--- ERROR PROBABLE DE CORS/CSP (BLOQUEO DE RED) ---");
                        console.error("Si ve este error, la solución es alojar este archivo HTML externamente e incrustar la URL en Google Sites.");
                    }
                    
                    if (i === maxRetries - 1) {
                        console.error("Gemini API Error después de todos los reintentos:", error);
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }
        
        // ----------------------------------------------------
        // II. LÓGICA DE LA INTERFAZ
        // ----------------------------------------------------
        
        lucide.createIcons();

        const supportButton = document.getElementById('support-toggle-button');
        const modal = document.getElementById('ai-support-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatHistory = document.getElementById('chat-history');
        
        // Mensaje inicial de la IA
        const welcomeMessageText = "Hola, soy Universo Helper. Estoy aquí para ayudarte con problemas de TI comunes como contraseñas, VPN, o correo. Si necesitas más ayuda, puedes 'Abrir un Ticket'.";

        let chatMessages = [
            { role: "model", parts: [{ text: welcomeMessageText }] }
        ];

        function initializeChatUI() {
            addMessage('model', welcomeMessageText);
        }

        function toggleModal() {
            const isClosed = modal.classList.contains('modal-closed');
            
            if (isClosed) {
                modal.classList.remove('modal-closed');
                modal.classList.add('modal-open');
                userInput.focus();
            } else {
                modal.classList.remove('modal-open');
                modal.classList.add('modal-closed');
            }
        }

        supportButton.addEventListener('click', (e) => {
            e.preventDefault();
            toggleModal();
        });

        closeModalBtn.addEventListener('click', toggleModal);
        
        // Función para agregar un mensaje a la interfaz
        function addMessage(sender, text) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `text-sm p-3 max-w-[85%] whitespace-pre-wrap ${
                sender === 'user' 
                ? 'bubble-user' 
                : 'bubble-model'
            }`;
            messageBubble.innerText = text; 

            messageContainer.appendChild(messageBubble);
            chatHistory.appendChild(messageContainer);
            chatHistory.scrollTop = chatHistory.scrollHeight; 
        }
        
        // Función para mostrar/ocultar el indicador de carga del modelo
        function showLoading(show) {
            const loadingId = 'model-loading-indicator';
            let loadingElement = document.getElementById(loadingId);

            if (show) {
                if (!loadingElement) {
                    loadingElement = document.createElement('div');
                    loadingElement.id = loadingId;
                    loadingElement.className = 'flex justify-start';
                    loadingElement.innerHTML = `
                        <div class="bubble-model text-sm p-3 max-w-[85%] flex items-center gap-2">
                            <div class="spinner border-t-4 border-[var(--color-primary)] w-4 h-4"></div> La IA está pensando...
                        </div>
                    `;
                    chatHistory.appendChild(loadingElement);
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }
            } else {
                if (loadingElement) {
                    loadingElement.remove();
                }
            }
        }
        
        // ----------------------------------------------------
        // III. LÓGICA DE INTERACCIÓN CON GEMINI
        // ----------------------------------------------------

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userText = userInput.value.trim();
            if (!userText) return;

            addMessage('user', userText);
            userInput.value = '';
            userInput.disabled = true;
            
            chatMessages.push({ role: "user", parts: [{ text: userText }] });

            showLoading(true);

            const payload = {
                contents: chatMessages,
                systemInstruction: {
                    parts: [{ 
                        text: "Actúa como un Asistente Virtual de Soporte TI llamado 'Universo Helper'. Tu objetivo es realizar un triage inicial de problemas comunes de TI. Mantén tus respuestas concisas (máximo dos párrafos). Si la pregunta es demasiado compleja, requiere acceso a sistemas, o la solución no es simple, dirige al usuario a 'Abrir un Ticket con Soporte' (menciona esta opción al final de la respuesta)." 
                    }]
                },
                config: {
                    temperature: 0.2
                }
            };

            try {
                const result = await fetchWithRetry(payload);
                const modelText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, hubo un problema al generar la respuesta.";
                
                addMessage('model', modelText);
                chatMessages.push({ role: "model", parts: [{ text: modelText }] });

            } catch (error) {
                // Mensaje de error visible para el usuario si la API falla
                const userFacingError = '⚠️ Hubo un error de conexión con el Asistente IA. Esto probablemente se debe a las restricciones de seguridad del sitio web (CSP/CORS). Por favor, intenta de nuevo o haz clic en "Abrir un Ticket con Soporte" si necesitas ayuda urgente.';
                addMessage('model', userFacingError);
                // Si la clave API está vacía y falló, es un problema de Canvas o del entorno.
                if (apiKey === "") {
                    console.warn("ADVERTENCIA: La clave API está vacía. Esto solo funciona en entornos de Canvas que la inyectan. Si está en producción, debe tener una clave válida.");
                }
            } finally {
                showLoading(false);
                userInput.disabled = false;
                userInput.focus();
            }
        });

        document.addEventListener('DOMContentLoaded', initializeChatUI);
        
    </script>
</body>
</html>
